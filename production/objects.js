function ObjectsManager(t,e){this.objects=[],this.keepers=[],this.movingObjects=[],this.staticObjects=[],this.movingParticles=[],this.autoShooters=[],this.renderObject=function(e){t.drawImage(e.texture,e.x,e.y)},this.renderAll=function(){for(var e=0;e<this.objects.length;e++)t.drawImage(this.objects[e].texture,this.objects[e].x,this.objects[e].y)},this.sortObjects=function(){this.objects.sort(function(t,e){return t.y+t.tileOffsetY-(e.y+e.tileOffsetY)!=0?t.y+t.tileOffsetY-(e.y+e.tileOffsetY):t.x-e.x})},this.registerObj=function(t,s){e.tiles[s].object.push(t),t.index=s,t.blocking&&(e.tiles[s].blocked=!0),t.double&&(e.tiles[s+1].object.push(t),t.blocking&&(e.tiles[s+1].blocked=!0))},this.unregisterObj=function(t,s){removeFromArray(e.tiles[s].object,t),t.blocking&&(e.tiles[s].blocked=!1),t.double&&(removeFromArray(e.tiles[s+1].object,t),t.blocking&&(e.tiles[s+1].blocked=!1))},this.moveObj=function(t){var s=transIndex1to2(t.path[t.path.length-1],e)[0]*e.tsize,i=transIndex1to2(t.path[t.path.length-1],e)[1]*e.tsize;t.path[t.path.length-1]==t.path[t.path.length-2]+1?t.x>s-40?(t.moveLeft(),t.x%e.tsize>=.5&&(this.unregisterObj(t,transIndex2to1([Math.ceil(t.x/e.tsize),(t.y+t.tileOffsetY)/e.tsize],e)),this.registerObj(t,transIndex2to1([Math.floor(t.x/e.tsize),(t.y+t.tileOffsetY)/e.tsize],e)))):t.path.pop():t.path[t.path.length-1]==t.path[t.path.length-2]-1?t.x<s+40?(t.moveRight(),t.x%e.tsize>=.5&&(this.unregisterObj(t,transIndex2to1([Math.floor(t.x/e.tsize),(t.y+t.tileOffsetY)/e.tsize],e)),this.registerObj(t,transIndex2to1([Math.ceil(t.x/e.tsize),(t.y+t.tileOffsetY)/e.tsize],e)))):t.path.pop():t.path[t.path.length-1]==t.path[t.path.length-2]-e.cols?t.y<i+40-t.tileOffsetY?(t.moveDown(),t.y%e.tsize>=.5&&(this.unregisterObj(t,transIndex2to1([t.x/e.tsize,Math.floor((t.y+t.tileOffsetY)/e.tsize)],e)),this.registerObj(t,transIndex2to1([t.x/e.tsize,Math.ceil((t.y+t.tileOffsetY)/e.tsize)],e)))):t.path.pop():t.path[t.path.length-1]==t.path[t.path.length-2]+e.cols&&(t.y>i-40-t.tileOffsetY?(t.moveUp(),t.y%e.tsize>=.5&&(this.unregisterObj(t,transIndex2to1([t.x/e.tsize,Math.ceil((t.y+t.tileOffsetY)/e.tsize)],e)),this.registerObj(t,transIndex2to1([t.x/e.tsize,Math.floor((t.y+t.tileOffsetY)/e.tsize)],e)))):t.path.pop()),this.sortObjects()},this.moveAll=function(){for(var t=0;t<this.movingObjects.length;t++)this.movingObjects[t].path.length>0&&this.moveObj(this.movingObjects[t]);for(var s=this.movingParticles.length-1;s>=0;s--){var i=transIndex2to1([Math.floor(this.movingParticles[s].x/e.tsize),Math.floor(this.movingParticles[s].y/e.tsize)],e);this.movingParticles[s].x<=5?(removeFromArray(this.objects,this.movingParticles[s]),this.movingParticles.splice(s,1)):"mountains"==e.tiles[i].terrain?(removeFromArray(this.objects,this.movingParticles[s]),this.movingParticles.splice(s,1)):0==e.tiles[i].object.length||"Menhir"!=e.tiles[i].object[0].name&&"Stone"!=e.tiles[i].object[0].name?Math.abs(this.movingParticles[s].x-this.movingParticles[s].goalX)<3&&Math.abs(this.movingParticles[s].y-this.movingParticles[s].goalY)<3&&(removeFromArray(this.objects,this.movingParticles[s]),this.movingParticles.splice(s,1)):(removeFromArray(this.objects,this.movingParticles[s]),this.movingParticles.splice(s,1)),this.movingParticles[s]&&this.movingParticles[s].move()}},this.shoot=function(t,e){this.spawnObject(Projectile,[t.x+20,t.y+20],e,t)},this.processShooters=function(){if(0==this.autoShooters.length)return-1;for(var t=0;t<this.autoShooters.length;t++){var s=this.autoShooters[t].index,i=transIndex1to2(s,e),h=this.autoShooters[t],o=[];"The orb"==h.name?o.push("Enemy"):"Enemy"==h.name&&(o.push("The orb"),o.push("Mage"));var n=function(){for(var t=1;t<=h.shootingRange;t++){for(var s=[],n=2*t+1,r=-t;r<=t;r++)for(var a=0;a<n;a++)transIndex2to1([i[0]-t+a,i[1]+r],e)&&s.push(transIndex2to1([i[0]-t+a,i[1]+r],e));for(var l=0;l<s.length;l++)if(0!=e.tiles[s[l]].object.length&&o.includes(e.tiles[s[l]].object[0].name))return s[l]}return null}();if(n){var r=transIndex1to2(n,e);this.shoot(h,[r[0]*e.tsize+e.tsize/2,r[1]*e.tsize+e.tsize/2])}}},this.spawnObject=function(t,s,i,h){var o=[0,Math.floor(e.rows/2)*e.tsize],n=(e.tsize,Math.floor(e.rows/2),e.tsize,[(e.cols-4)*e.tsize,Math.floor(e.rows/2)*e.tsize]);t==Enemy&&(s=[0,Math.floor(e.rows/2)*e.tsize]);for(var r=transIndex2to1([s[0]/e.tsize,s[1]/e.tsize],e),a=new t(s,i);a.double&&e.tiles[r+1].blocked;)a=new t(s);for(var l=0;l<a.tags.length;l++)this[a.tags[l]].push(a);if(t==Enemy){var c=[];c.push(findPath(e,transIndex2to1([o[0]/e.tsize,o[1]/e.tsize],e),transIndex2to1([n[0]/e.tsize-1,n[1]/e.tsize],e))),c.push(findPath(e,transIndex2to1([o[0]/e.tsize,o[1]/e.tsize],e),transIndex2to1([n[0]/e.tsize,n[1]/e.tsize-1],e))),c.push(findPath(e,transIndex2to1([o[0]/e.tsize,o[1]/e.tsize],e),transIndex2to1([n[0]/e.tsize,n[1]/e.tsize+1],e))),c.push(findPath(e,transIndex2to1([o[0]/e.tsize,o[1]/e.tsize],e),transIndex2to1([n[0]/e.tsize+1,n[1]/e.tsize],e))),c.sort(function(t,e){return t.length-e.length}),a.path=c[0],a.path.shift()}t==Projectile&&(a.shooter=h),t!=Projectile&&this.registerObj(a,r),this.sortObjects()},this.createMenhirs=function(){for(var t=0;t<e.tiles.length;t++)if(!e.tiles[t].blocked&&Math.random()<.05){var s=transIndex1to2(t,e);this.spawnObject(Menhir,[s[0]*e.tsize,s[1]*e.tsize])}},this.createStones=function(){for(var t=0;t<e.tiles.length;t++)if(!e.tiles[t].blocked&&Math.random()<.05){var s=transIndex1to2(t,e);this.spawnObject(Stone,[s[0]*e.tsize,s[1]*e.tsize])}},this.createTests=function(){for(var t=0;t<e.tiles.length;t++)if(!e.tiles[t].blocked&&Math.random()<.05){var s=transIndex1to2(t,e);this.spawnObject(Test,[s[0]*e.tsize,s[1]*e.tsize])}}}function Enemy(t){this.index,this.hitpoints=100,this.tileOffsetY=0,this.texture=document.getElementById("enemy-1"),this.x=t[0],this.y=t[1],this.width=this.texture.width,this.height=this.texture.height,this.speed=.5,this.path=[],this.blocking=!1,this.double=!1,this.shootingRange=2,this.name="Enemy",this.tags=["objects","movingObjects"],this.moveRight=function(){this.x+=this.speed},this.moveLeft=function(){this.x-=this.speed},this.moveUp=function(){this.y-=this.speed},this.moveDown=function(){this.y+=this.speed}}function Mage(t){this.index,this.hitpoints=300,this.tileOffsetY=20,this.x=t[0],this.y=t[1]-this.tileOffsetY,this.texture=document.getElementById("mage-1"),this.width=this.texture.width,this.height=this.texture.height,this.speed=2,this.waypoints=[],this.path=[],this.walkingMode=!1,this.shootingMode=!0,this.tags=["objects","movingObjects","keepers"],this.blocking=!0,this.double=!1,this.name="Mage",this.frags=0,this.moveRight=function(){this.x+=this.speed},this.moveLeft=function(){this.x-=this.speed},this.moveUp=function(){this.y-=this.speed},this.moveDown=function(){this.y+=this.speed}}function Orb(t){this.index,this.hitpoints=300,this.x=t[0],this.y=t[1],this.tileOffsetY=0,this.texture=document.getElementById("enemy-1"),this.width=this.texture.width,this.height=this.texture.height,this.blocking=!0,this.shootingRange=2,this.double=!1,this.name="The orb",this.tags=["objects","autoShooters"],this.frags=0}function Projectile(t,e){this.texture=document.getElementById("projectile-1"),this.width=this.texture.width,this.height=this.texture.height,this.tags=["objects","movingParticles"],this.shooter,this.tileOffsetY=0,this.blocking=!1,this.double=!1,this.x=t[0],this.y=t[1],this.goalX=e[0],this.goalY=e[1],this.dx=e[0]-t[0],this.dy=e[1]-t[1],this.sx=this.dx>=0?1:-1,this.sy=this.dy>=0?1:-1,this.coefX=Math.abs(this.dx/this.dy),this.coefY=Math.abs(this.dy/this.dx),this.speed=5,this.d=0,this.move=function(){this.coefX<this.coefY?(this.x+=this.speed*this.sx*this.coefX,this.y+=this.speed*this.sy):this.coefX>this.coefY?(this.x+=this.speed*this.sx,this.y+=this.speed*this.sy*this.coefY):(this.x+=this.speed*this.sx,this.y+=this.speed*this.sy),this.d+=this.speed}}function Menhir(t){this.index,this.texture=document.getElementById("menhir-"+(Math.floor(1*Math.random())+1)),this.tags=["objects","staticObjects"],this.tileOffsetY=40,this.x=t[0],this.y=t[1]-this.tileOffsetY,this.width=this.texture.width,this.height=this.texture.height,this.name="Menhir",this.sleeping=!0,this.blocking=!0,this.double=!1}function Stone(t){this.index,this.texture=document.getElementById("stone-"+(Math.floor(3*Math.random())+1)),this.tags=["objects","staticObjects"],this.tileOffsetY=this.texture.height-40,this.x=t[0],this.y=t[1]-this.tileOffsetY,this.width=this.texture.width,this.height=this.texture.height,this.name="Stone",this.blocking=!0,this.double=this.texture.width>80}function Test(t){this.index,this.texture=document.getElementById("test-1"),this.tags=["objects","staticObjects"],this.tileOffsetY=this.texture.height-40,this.x=t[0],this.y=t[1]-this.tileOffsetY,this.width=this.texture.width,this.height=this.texture.height,this.name="Test",this.blocking=!0,this.double=this.texture.width>80}